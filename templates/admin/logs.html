<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Development Logs Viewer</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles/styles.css') }}"
    />
  </head>
  <body>
    <div class="logs-container">
      <h1>Development Logs Viewer</h1>

      <div class="search-section">
        <h3>Search Logs</h3>
        <div class="search-inputs">
          <input
            type="text"
            id="devTypeSearch"
            placeholder="Search by development type (e.g., Carport, Shed)"
            onkeypress="if(event.key==='Enter') searchLogs()"
          />
          <input
            type="text"
            id="addressSearch"
            placeholder="Search by property address"
            onkeypress="if(event.key==='Enter') searchLogs()"
          />
          <button onclick="searchLogs()">Search</button>
          <button onclick="loadAllLogs()">Show All</button>
          <button onclick="clearSearch()">Clear</button>
        </div>
      </div>

      <div class="stats" id="stats">
        <strong>Total Submissions: </strong><span id="totalCount">-</span>
      </div>

      <div id="errorMessage" class="error" style="display: none"></div>
      <div id="loading" class="loading" style="display: none">
        Loading logs...
      </div>
      <table id="logsTable" style="display: none">
        <thead>
          <tr>
            <th>ID</th>
            <th>Development Type</th>
            <th>Property Address</th>
            <th>Answers (JSON)</th>
            <th>Reference Number</th>
            <th>Timestamp</th>
          </tr>
        </thead>
        <tbody id="logsTableBody"></tbody>
      </table>

      <div id="noData" class="no-data" style="display: none">
        No submissions found.
      </div>
    </div>

    <script>
      // load all logs when loading
      document.addEventListener("DOMContentLoaded", function () {
        loadAllLogs();
      });

      async function loadAllLogs() {
        showLoading();
        try {
          const response = await fetch("/logs");

          // Check if response is JSON
          const contentType = response.headers.get("content-type");
          if (!contentType || !contentType.includes("application/json")) {
            throw new Error(
              "Server returned non-JSON response. Make sure the /logs endpoint is implemented."
            );
          }

          const data = await response.json();

          if (response.ok) {
            displayLogs(data.submissions, data.total_count);
          } else {
            showError(data.error || "Failed to load logs");
          }
        } catch (error) {
          console.error("Error loading logs:", error);
          showError("Network error: " + error.message);
        }
      }

      async function searchLogs() {
        const devType = document.getElementById("devTypeSearch").value;
        const address = document.getElementById("addressSearch").value;

        if (!devType && !address) {
          loadAllLogs();
          return;
        }

        showLoading();
        try {
          const params = new URLSearchParams();
          if (devType) params.append("dev_type", devType);
          if (address) params.append("address", address);

          const response = await fetch("/logs/search?" + params.toString());

          // Check if response is JSON
          const contentType = response.headers.get("content-type");
          if (!contentType || !contentType.includes("application/json")) {
            throw new Error(
              "Server returned non-JSON response. Make sure the /logs/search endpoint is implemented."
            );
          }

          const data = await response.json();

          if (response.ok) {
            displayLogs(data.submissions, data.total_count);
          } else {
            showError(data.error || "Failed to search logs");
          }
        } catch (error) {
          console.error("Error searching logs:", error);
          showError("Network error: " + error.message);
        }
      }

      function displayLogs(submissions, totalCount) {
        hideLoading();
        hideError();

        document.getElementById("totalCount").textContent = totalCount;

        if (submissions.length === 0) {
          showNoData();
          return;
        }

        hideNoData();

        const tableBody = document.getElementById("logsTableBody");
        tableBody.innerHTML = "";

        submissions.forEach((submission) => {
          const row = document.createElement("tr");

          // Format answers JSON for display
          const answersFormatted = JSON.stringify(
            submission.answers_json,
            null,
            2
          );

          row.innerHTML = `
                    <td>${submission.id}</td>
                    <td class="dev-type">${submission.dev_type}</td>
                    <td>${submission.property_address}</td>
                    <td class="answers-cell"><pre class="json-formatted">${answersFormatted}</pre></td>
                    <td>${submission.reference_no || "-"}</td>
                    <td class="timestamp">${formatTimestamp(
                      submission.timestamp
                    )}</td>
                `;

          tableBody.appendChild(row);
        });

        document.getElementById("logsTable").style.display = "table";
      }

      function showLoading() {
        document.getElementById("loading").style.display = "block";
        document.getElementById("logsTable").style.display = "none";
        hideNoData();
        hideError();
      }

      function hideLoading() {
        document.getElementById("loading").style.display = "none";
      }

      function showError(message) {
        document.getElementById("errorMessage").textContent = message;
        document.getElementById("errorMessage").style.display = "block";
        hideLoading();
        hideNoData();
      }

      function hideError() {
        document.getElementById("errorMessage").style.display = "none";
      }

      function showNoData() {
        document.getElementById("noData").style.display = "block";
        document.getElementById("logsTable").style.display = "none";
      }

      function hideNoData() {
        document.getElementById("noData").style.display = "none";
      }

      function clearSearch() {
        document.getElementById("devTypeSearch").value = "";
        document.getElementById("addressSearch").value = "";
        loadAllLogs();
      }

      function formatTimestamp(timestamp) {
        try {
          const date = new Date(timestamp);
          return date.toLocaleString();
        } catch (error) {
          return timestamp;
        }
      }
    </script>
  </body>
</html>
